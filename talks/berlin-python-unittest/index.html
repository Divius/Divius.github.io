<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Unit testing Python</title>
                <meta name="author" content="Dmitry Tantsur (divius.inside@gmail.com)">

		<link rel="stylesheet" href="../reveal.js/css/reveal.css">
		<link rel="stylesheet" href="../reveal.js/css/theme/dtantsur.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="../reveal.js/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi) ? '../reveal.js/css/print/pdf.css' : '../reveal.js/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
                <style>
                    .reveal pre code { font-size: 75%; }
                    .reveal blockquote { font-style: italic; }
                    .reveal var.file {
                        font-size: 75%;
                        border-top: solid rgb(63, 63, 63);
                        border-left: solid rgb(63, 63, 63);
                        border-right: solid rgb(63, 63, 63);
                        padding-left: 15px;
                        padding-right: 15px;
                    }
                </style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

<section>
    <h1 class="title">Unit testing Python</h1>
    <br><br>
    <p><small>Dmitry Tantsur (Principal Software Engineer, Red Hat)</small></p>
    <p><small>Slides:
        <a href="https://dtantsur.github.io/talks/berlin-python-unittest/">
            dtantsur.github.io/talks/berlin-python-unittest</a>
    </small></p>
    <p><small>Code:
        <a href="https://github.com/dtantsur/berlin-python-unittest">
            github.com/dtantsur/berlin-python-unittest</a>
    </small></p>
</section>

<section>
    <h1>Agenda</h1>
    <ul>
        <li>Automated testing: how and why?</li>
        <li>Writing and running Python tests:
            <ul>
                <li>The unittest package</li>
                <li>Discovering tests</li>
                <li>Assertion methods</li>
            </ul>
        </li>
        <li>Mocking:
            <ul>
                <li>Mock and MagicMock</li>
                <li>Patching objects</li>
                <li>Spec and autospec</li>
            </ul>
        </li>
        <li>Extras:
            <ul>
                <li>Additional runners</li>
                <li>Measuring coverage</li>
                <li>Creating and using fixtures</li>
            </ul>
        </li>
    </ul>
</section>

<section><!-- Automated testing -->

<section>
    <h1 class="title">Automated testing</h1>
    <h2>How and why?</h2>
</section>

<section>
    <h1>Automated testing</h1>
    <h2>What?</h2>
    <p>Using a program to verify correctness of a program (library, module,
    any piece of software).</p>
</section>

<section>
    <h1>Automated testing</h1>
    <h2>Why?</h2>
    <ul>
        <li>Decisiveness</li>
        <li>Repeatability</li>
        <li>Parallelism</li>
        <li>Coverage</li>
    </ul>
</section>

<section>
    <h1>Automated testing</h1>
    <h2>Types</h2>
    <ul>
        <li>Black box</li>
        <li>White box</li>
    </ul>
</section>

<section>
    <h1>Automated testing</h1>
    <h2>Types</h2>
    <ul>
        <li>Unit</li>
        <li>Integration</li>
        <li>Functional</li>
    </ul>
</section>

<section>
    <h1>Automated testing</h1>
    <h2>Unit testing</h2>
    <div>
        <img src="unit.svg" alt="Testing types: unit" style="border: 0">
    </div>
    <p><small>Usually white box</small></p>
</section>

<section>
    <h1>Automated testing</h1>
    <h2>Integration testing</h2>
    <div>
        <img src="integration.svg" alt="Testing types: integration" style="border: 0">
    </div>
    <p><small>Usually black box</small></p>
</section>

<section>
    <h1>Automated testing</h1>
    <h2>Functional testing</h2>
    <div>
        <img src="functional.svg" alt="Testing types: functional" style="border: 0">
    </div>
    <p><small>Black box</small></p>
</section>

</section><!-- Automated testing -->

<section><!-- Unit test framework -->

<section>
    <h1 class="title">Unit test framework</h1>
</section>

<section>
    <h1>Unit test framework</h1>
    <ul>
        <li>Included in the standard library</li>
        <li>Heavily extended in Python 3</li>
        <li>Plenty 3rd party addons</li>
    </ul>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Case study: quadratic equation</h2>
    <p>Package layout:</p>
    <pre><code class="bash">$ find my_utils
my_utils
my_utils/roots.py
my_utils/__init__.py
my_utils/tests
my_utils/tests/__init__.py
my_utils/tests/test_roots.py</code></pre>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Case study: quadratic equation</h2>
    <var class="file">my_utils/roots.py</var>
    <pre><code class="python">import math

def roots(a, b, c):
    if not a:
        raise ValueError("a cannot be zero")

    discriminant = b ** 2 - 4 * a * c
    if discriminant &lt; 0:
        raise ValueError("discriminant below zero")

    return ((- b - math.sqrt(discriminant)) / 2 / a,
            (- b + math.sqrt(discriminant)) / 2 / a)
</code></pre>
</section>

<section>
    <h1>Writing unit tests</h1>
    <ul>
        <li>Split the testing into independent checks</li>
        <li>Group individual checks into cases</li>
        <li>Don't forget negative tests</li>
    </ul>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Case study: quadratic equation</h2>
    <var class="file">my_utils/tests/test_roots.py</var>
    <pre><code class="python">import unittest
from my_utils.roots import roots

class RootsTest(unittest.TestCase):
    def test_same_root(self):
        self.assertEqual(roots(1, -4, 4), (2.0, 2.0))

    def test_different_roots(self):
        self.assertEqual(roots(1, -3, 2), (1.0, 2.0))

    def test_negative_a(self):
        self.assertRaises(ValueError, roots, 0, -3, 2)

    def test_negative_discriminant(self):
        self.assertRaises(ValueError, roots, 1, 1, 1)</code></pre>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Case study: quadratic equation</h2>
    <p>Running only one test file:</p>
    <pre><code class="bash">$ python3 -m unittest my_utils.tests.test_roots
....
----------------------------------------------------------------------
Ran 4 tests in 0.000s

OK</code></pre>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Case study: quadratic equation</h2>
    <p>Detecting and running all tests:</p>
    <pre><code class="bash">$ python3 -m unittest discover my_utils
....
----------------------------------------------------------------------
Ran 4 tests in 0.000s

OK</code></pre>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Case study: quadratic equation</h2>
    <p>And this is how it fails:</p>
    <pre><code class="bash" style="font-size: 40%">$ python3 -m unittest discover my_utils
F...
======================================================================
FAIL: test_different_roots (tests.test_roots.RootsTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/dtantsur/Projects/berlin-python-unittest/my_utils/tests/test_roots.py", line 11, in test_different_roots
    self.assertEqual(roots(1, -3, 2), (1.0, 2.0))
AssertionError: Tuples differ: (1.0, 1.0) != (1.0, 2.0)

First differing element 1:
1.0
2.0

- (1.0, 1.0)
?       ^

+ (1.0, 2.0)
?       ^


----------------------------------------------------------------------
Ran 4 tests in 0.002s

FAILED (failures=1)
    </code></pre>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Quadratic equation: imports</h2>
    <var class="file">my_utils/tests/test_roots.py</var>
    <pre><code class="python">import unittest
from my_utils.roots import roots</code></pre>
    <p>Importing the standard unittest package and our code that we plan on
    testing.</p>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Quadratic equation: test case</h2>
    <var class="file">my_utils/tests/test_roots.py</var>
    <pre><code class="python">class RootsTest(unittest.TestCase):
    def test_same_root(self):
        # ...

    def test_different_roots(self):
        # ...

    # ...</code></pre>
    <ul>
        <li>A test case is a logical group of tests</li>
        <li>Each test is a method starting with test_</li>
        <li>Each tests one aspect of the tested entity</li>
    </ul>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Quadratic equation: equality</h2>
    <var class="file">my_utils/tests/test_roots.py</var>
    <pre><code class="python">def test_same_root(self):
    self.assertEqual(roots(1, -4, 4), (2.0, 2.0))

def test_different_roots(self):
    self.assertEqual(roots(1, -3, 2), (1.0, 2.0))</code></pre>
    <ol>
        <li>Calculate the value using the function under test</li>
        <li>Compare it with the known correct result</li>
    </ol>
    <p>Using convenience methods self.assert&lt;***&gt;</p>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Quadratic equation: errors</h2>
    <var class="file">my_utils/tests/test_roots.py</var>
    <pre><code class="python">def test_negative_a(self):
    self.assertRaises(ValueError, roots, 0, -3, 2)

def test_negative_discriminant(self):
    self.assertRaises(ValueError, roots, 1, 1, 1)</code></pre>
    <ul>
        <li>Use assertRaises to check that a callable raises an exception
            on invalid input</li>
        <li>Note that we do not call it ourselves!</li>
    </ul>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Quadratic equation: errors</h2>
    <var class="file">my_utils/tests/test_roots.py</var>
    <pre><code class="python">def test_negative_a(self):
    self.assertRaisesRegex(ValueError, 'a cannot be zero',
                           roots, 0, -3, 2)

def test_negative_discriminant(self):
    self.assertRaisesRegex(ValueError, 'discriminant below zero',
                           roots, 1, 1, 1)</code></pre>
    <ul>
        <li>Use assertRaisesRegex to validate the error message</li>
        <li>Useful to distinguish between different cases of the same error</li>
    </ul>
</section>

<section>
    <h1>Unit test framework</h1>
    <h2>Available checks</h2>
    <p>assertEqual, assertNotEqual, assertIs, assertIsNot, assertTrue,
    assertFalse, assertIsInstance, assertNotIsInstance, assertIn, assertNotIn,
    assertGreater, assertGreaterEqual, assertLess, assertLessEqual,
    assertRegex, assertNotRegex, assertRaises, assertRaisesRegex</p>
    <p>... and probably more</p>
    <p>... and even more in 3rd party libraries</p>
</section>

</section><!-- Unit test framework -->

<section>
    <h1 class="title">Questions?</h1>
</section>

			</div>
		</div>

		<script src="../reveal.js/lib/js/head.min.js"></script>
		<script src="../reveal.js/js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
                                history: true,
                                transitionSpeed: 'fast',
				dependencies: [
					{ src: '../reveal.js/plugin/markdown/marked.js' },
					{ src: '../reveal.js/plugin/markdown/markdown.js' },
					{ src: '../reveal.js/plugin/notes/notes.js', async: true },
					{ src: '../reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
