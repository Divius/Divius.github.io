<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Denver PTG Summary: Ironic (part 1) | Coding Music</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#FFFFFF">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="http://dtantsur.github.io/posts/ironic-ptg-denver-2017-1.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="Dmitry Tantsur">
<link rel="prev" href="ironic-ptg-atlanta-2017-4.html" title="Atlanta PTG Summary: Ironic (part 4)" type="text/html">
<link rel="next" href="ironic-ptg-denver-2017-2.html" title="Denver PTG Summary: Ironic (part 2)" type="text/html">
<meta property="og:site_name" content="Coding Music">
<meta property="og:title" content="Denver PTG Summary: Ironic (part 1)">
<meta property="og:url" content="http://dtantsur.github.io/posts/ironic-ptg-denver-2017-1.html">
<meta property="og:description" content="This is an extract from my personal notes and public etherpads from the
OpenStack PTG 2017 in Denver. A lot of text ahead!
This part covers Pike recap and retrospective, status updates and CI work.
Ne">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-09-21T15:22:52+02:00">
<meta property="article:tag" content="openstack">
<meta property="article:tag" content="software">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://dtantsur.github.io/">

                <span id="blog-title">Coding Music</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Tags <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../categories/music.html">Music</a>
                    </li>
<li>
<a href="../categories/openstack.html">OpenStack</a>
                    </li>
<li>
<a href="../categories/software.html">Software</a>
            </li>
</ul>
</li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Talks <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../talks/pike-ironic-cleaning-deep-dive/">Ironic Cleaning Deep Dive (Pike Version)</a>
                    </li>
<li>
<a href="../talks/pike-ironic-deploy-deep-dive/">Ironic Deploy Deep Dive (Pike Version)</a>
                    </li>
<li>
<a href="../talks/mitaka-inspector-status">Ironic Inspector Mitaka Status</a>
                    </li>
<li>
<a href="../talks/whatsnew-ironic-mitaka">What's New in Ironic Mitaka</a>
                    </li>
<li>
<a href="../talks/fosdem2016">FOSDEM16: Ironic Debugging</a>
            </li>
</ul>
</li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Social <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="https://instagram.com/creepy_owlet">My Instagram</a>
                    </li>
<li>
<a href="https://github.com/dtantsur">My Github</a>
            </li>
</ul>
</li>
<li>
<a href="../archive.html">Archives</a>
                </li>
<li>
<a href="../rss.xml">RSS</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Denver PTG Summary: Ironic (part 1)</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Dmitry Tantsur
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2017-09-21T15:22:52+02:00" itemprop="datePublished" title="2017-09-21 15:22">2017-09-21 15:22</time></a></p>
                <p class="commentline">
        
    <a href="ironic-ptg-denver-2017-1.html#disqus_thread" data-disqus-identifier="cache/posts/ironic-ptg-denver-2017-1.html">Comments</a>


            

        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>This is an extract from my personal notes and <a class="reference external" href="https://etherpad.openstack.org/p/ironic-queens-ptg">public etherpads</a> from the
OpenStack PTG 2017 in Denver. A lot of text ahead!</p>
<p>This part covers Pike recap and retrospective, status updates and CI work.</p>
<p><a class="reference external" href="ironic-ptg-denver-2017-2.html">Next part</a>.</p>
<!-- TEASER_END: Read more -->
<div class="section" id="status-of-pike-priorities">
<h2>Status of Pike priorities</h2>
<p>In the Pike cycle, we had 22 priority items. Quite a few planned priorities
did land completely, despite the well-known staffing problems.</p>
<div class="section" id="finished">
<h3>Finished</h3>
<div class="section" id="booting-from-cinder-volumes">
<h4>Booting from cinder volumes</h4>
<p>This includes the iRMC implementation, but excludes the iLO one. There is
also a nova patch for updating IP addresses for volume connectors on review:
<a class="reference external" href="https://review.openstack.org/#/c/468353/">https://review.openstack.org/#/c/468353/</a>.</p>
<p>Next, we need to update cinder to support FCoE - then we'll be able to
support it in the generic PXE boot interface. Finally, there is some interest
in implementing out-of-band BFV for UCS drivers too.</p>
</div>
<div class="section" id="rolling-online-upgrades-between-releases">
<h4>Rolling (online) upgrades between releases</h4>
<p>We've found a bug that was backported to stable/pike soon after the release
and now awaits a point release. We also need developer documentation and
some post-Pike clean ups.</p>
<p>We also discussed fast-forward upgrades. We may need an explicit migration
for VIFs from port.extra to port.internal_info, <strong>rloo</strong> will track this.
Overall, we need to always make our migrations explicit and runnable without
the services running.</p>
</div>
<div class="section" id="the-driver-composition-reform">
<h4>The driver composition reform</h4>
<p>Finished, with hardware types created for all supported hardware, and the
classic drivers pending deprecation in Queens.</p>
<p><a class="reference external" href="http://specs.openstack.org/openstack/ironic-specs/specs/approved/classic-drivers-future.html">Removing the classic drivers</a> is planned for Rocky.</p>
</div>
<div class="section" id="standalone-jobs-jobs-without-nova">
<h4>Standalone jobs (jobs without nova)</h4>
<p>These are present and voting, but we're not using their potential. The
discussion is summarized below in <a class="reference internal" href="ironic-ptg-denver-2017-1.html#future-development-of-our-ci">Future development of our CI</a>.</p>
</div>
<div class="section" id="feature-parity-between-two-cli-implementations">
<h4>Feature parity between two CLI implementations</h4>
<p>The <tt class="docutils literal">openstack baremetal</tt> CLI is now complete and preferred, with the
deprecation of the <tt class="docutils literal">ironic</tt> CLI expected in Queens.</p>
<p>We would like OSC to have less dependencies though. There were talks about
having a standalone <tt class="docutils literal">openstack</tt> command without dependencies on other
clients, only on <tt class="docutils literal">keystoneauth1</tt>. <strong>rloo</strong> will follow up here.</p>
<p><strong>TheJulia</strong> will check if there are any implications from the
interoperability team point of view.</p>
</div>
<div class="section" id="redfish-hardware-type">
<h4>Redfish hardware type</h4>
<p>The <tt class="docutils literal">redfish</tt> hardware type now provides all the basic stuff we need, i.e.
power and boot device management. There is an ongoing effort to implement
inspection. It is unclear whether more features can be implemented in a
vendor-agnostic fashion; <strong>rpioso</strong> is looking into Dell, while <strong>crushil</strong>
is looking into Lenovo.</p>
</div>
<div class="section" id="other">
<h4>Other</h4>
<p>Also finished are:</p>
<ul class="simple">
<li>Post-deploy VIF attach/detach.</li>
<li>Physical network awareness.</li>
</ul>
</div>
</div>
<div class="section" id="not-finished">
<h3>Not finished</h3>
<div class="section" id="osc-default-api-version">
<h4>OSC default API version</h4>
<p>We now issue a warning of no explicit version is provided to the CLI.
The next step will be to change the version to latest, but our current
definition of latest does not fit this goal really well. We use the latest
version known to the client, which will prevent it from working out-of-box
with older clouds. Instead, we need to finally implement API version
negotiation in ironicclient, and negotiate the latest version.</p>
</div>
<div class="section" id="reference-architectures-guide">
<h4>Reference architectures guide</h4>
<p>There is one patch that lays out considerations that are going to be shared
between all proposed architectures. The use cases we would like to cover:</p>
<ul>
<li>
<p class="first">Admin-only provisioner (standalone architectures)</p>
<ul>
<li>
<p class="first">Small fleet and/or rare provisions.</p>
<p>Here a non-HA architecture may be acceptable, and a <em>noop</em> or <em>flat</em>
networking can be used.</p>
</li>
<li>
<p class="first">Large fleet or frequent provisions.</p>
<p>Here we will recommend HA and <em>neutron</em> networking. <em>Noop</em> networking is
also acceptable.</p>
</li>
</ul>
</li>
<li>
<p class="first">Bare metal cloud for end users (with nova)</p>
<ul>
<li>
<p class="first">Smaller single-site cloud.</p>
<p>Non-HA architecture and <em>flat</em> or <em>noop</em> networking is acceptable.
Ironic conductors can live on OpenStack controller nodes.</p>
</li>
<li>
<p class="first">Large single-site cloud.</p>
<p>HA is required, and it is recommended to split ironic conductors with
their TFTP/HTTP servers to separate machines. <em>Neutron</em> networking
should be used, and thus compatible switches will be required, as well
as their ML2 mechanism drivers.</p>
<p>It is preferred to use virtual media instead of PXE/iPXE for deployment
and cleaning, if supported by hardware. Otherwise, especially large
clouds may consider splitting away TFTP servers.</p>
</li>
<li>
<p class="first">Large multi-site cloud.</p>
<p>The same as a single-site cloud plus using Cells v2.</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="deploy-steps">
<h4>Deploy steps</h4>
<p>We agreed to continue this effort, even though the ansible deploy driver solves
some of its use cases. The crucial point is how to pass the requested deploy
steps parameters from a user to ironic. For a non-standalone case it means
passing them through nova.</p>
<p>In a discussion in the nova room we converged to an idea of introducing new
CRUD API for <em>deploy templates</em> (the exact name to be defined) on the ironic
side. Each such template will have a unique name and will correspond to a
<em>deploy step</em> and a set of arguments for it. On the nova side, a <em>trait</em> can
be requested with a name matching (in some sense) the name of a deploy
template. It will be passed to ironic, and ironic will apply the action,
specified in the template, during deployment.</p>
<p>The exact implementation and API will be defined in a spec, <strong>johnthetubaguy</strong>
is writing it.</p>
</div>
<div class="section" id="networking-features">
<h4>Networking features</h4>
<p>Routed network support is close to completion, we need to finish a patch for
networking-baremetal.</p>
<p>The neutron event processing work is on a spec stage, but does not look
controversial for now.</p>
<p>We also have patches up for deprecating DHCP providers and for making our DHCP
code less dnsmasq-specific.</p>
</div>
<div class="section" id="ironic-inspector-ha">
<h4>ironic-inspector HA</h4>
<p>Preparation work is under way. We are making our PXE boot management
pluggable, with a new implementation on review that manages a <em>dnsmasq</em>
process directly, instead of changing <em>iptables</em>.</p>
<p>We seem to agree that rolling upgrades are not a priority for
ironic-inspector, as it's never hit via end users either directly or through
another service. It's a purely admin-only API, and admins can plan for a
potential outage.</p>
<p>There is a proposal to support ironic boot interfaces instead of a home-grown
implementation for boot management. The discussion of it launched a more
global discussion about ironic-inspector future, that continued the next day.</p>
</div>
<div class="section" id="just-do-it">
<h4>Just Do It</h4>
<p>The following former priorities have all or the most of patches up for review,
and just require some attention:</p>
<ul class="simple">
<li>Node tags</li>
<li>IPA API versioning</li>
<li>Rescue mode</li>
<li>Supported power states API</li>
<li>E-Tags in API</li>
</ul>
</div>
</div>
</div>
<div class="section" id="openstack-goals-status">
<h2>OpenStack goals status</h2>
<p>We have not completed either of the two goals for the Pike cycle, and now we
have two more goals to complete. All four goals are relatively close to
completion.</p>
<div class="section" id="python-3">
<h3>Python 3</h3>
<p>We have a non-voting integration job on ironic and a voting functional test
job on ironic-inspector. The missing steps are:</p>
<ul class="simple">
<li>make the python 3 job voting on ironic</li>
<li>implement a job with IPA running on python 3 (blocked by pyudev weirdness)</li>
<li>create an integration job with python 3 for ironic-inspector (mostly blocked
by swift, will have reduced coverage; an alternative is to try RadosGW)</li>
</ul>
</div>
<div class="section" id="switching-to-uwsgi">
<h3>Switching to uWSGI</h3>
<p>Ironic standalone tests are running with mod_wsgi and voting, we only need to
switch to uWSGI.</p>
<p>For ironic-inspector it's much more complicated: it does not have a separate
API service for now at all. It's unclear if we'll able to just launch the
current service as it is behind a WSGI container, as we actively use green
threads. We have to probably wait until the HA work is done.</p>
</div>
<div class="section" id="splitting-away-the-tempest-plugin">
<h3>Splitting away the tempest plugin</h3>
<p>We have a script to extract git history for a sub-tree. We need to create a
separate git repository somewhere, so that we do not submit 60-80 related
patches to zuul. Then this repository will be imported by the infra team, and
we'll proceed with the migration.</p>
<p>On the previous (ATL) PTG we decided to have ironic and ironic-inspector
plugins co-located. This will be less confusing for external users, as many of
them to not understand the difference clearly, but it will also complicate the
migration.</p>
<p>We will need to plan the actual migration in advance, and freeze the version
in-tree for some time.</p>
</div>
<div class="section" id="policy-in-the-code">
<h3>Policy in the code</h3>
<p>The ironic part is essentially done, we just need to change the way we
document policy: <a class="reference external" href="https://review.openstack.org/#/c/502519/">https://review.openstack.org/#/c/502519/</a>.</p>
<p>No policy support exists in ironic-inspector, and it's unclear if this goal
assumes adding it. There is a desire to do so anyway.</p>
</div>
</div>
<div class="section" id="future-development-of-our-ci">
<h2>Future development of our CI</h2>
<div class="section" id="standalone-tests">
<h3>Standalone tests</h3>
<p>We have standalone tests voting, but we're not fully using their potential.
In the end, we want to reduce the number of <strong>non</strong>-standalone jobs to:</p>
<ol class="arabic simple">
<li>a whole disk image job,</li>
<li>a partition images job,</li>
<li>a boot-from-volume job,</li>
<li>a multi-node job with advanced networking (can be merged with one of the
first two),</li>
<li>two grenade jobs: full and partial.</li>
</ol>
<p>The following tests can likely be part of the standalone job:</p>
<ul class="simple">
<li>tests for all combinations of disk types and deploy methods,</li>
<li>tests covering all community-supported drivers (snmp, redfish),</li>
<li>tests on different boot options (local vs network boot),</li>
<li>tests on root device hints (we plan to cover serial number, wwn and size
with operators),</li>
<li>node adoption.</li>
</ul>
</div>
<div class="section" id="take-over-testing">
<h3>Take over testing</h3>
<p>The take over feature is very important for our HA model, but is completely
untested. We discussed the two most important test cases:</p>
<ol class="arabic simple">
<li>conductor failure during deployment with node in <tt class="docutils literal">deploy wait</tt>,</li>
<li>conductor failure for an active node using network boot.</li>
</ol>
<p>We discussed two ways of implementing the test: using a multi-node job with two
conductors or using only one conductor. The latter requires a trick: after
killing the conductor, change its host name, so that it looks like a new
conductor. In either case, we can combine both tests into one run:</p>
<ol class="arabic">
<li>
<p class="first">start deploying two nodes with netboot:</p>
<ol class="arabic simple">
<li>
<tt class="docutils literal"><span class="pre">driver=manual-management</span> deploy_interface=iscsi</tt>,</li>
<li>
<tt class="docutils literal"><span class="pre">driver=manual-management</span> deploy_interface=direct</tt>,</li>
</ol>
<p>The remaining steps will be repeated for both nodes.</p>
</li>
<li>
<p class="first">Wait for nodes <tt class="docutils literal">provision_state</tt> becomes <tt class="docutils literal">deploy wait</tt>.</p>
</li>
<li>
<p class="first">Kill the conductor.</p>
</li>
<li>
<p class="first">Manually clean up the files from the TFTP and HTTP directories and the
master image cache.</p>
</li>
<li>
<p class="first">Change the conductor host name in <tt class="docutils literal">ironic.conf</tt>.</p>
</li>
<li>
<p class="first">Wait for directories to be populated again.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We should aim to remove this step eventually.</p>
</div>
</li>
<li>
<p class="first"><tt class="docutils literal">virsh start</tt> the nodes to continue their deployment.</p>
</li>
<li>
<p class="first">Wait for nodes to become <tt class="docutils literal">active</tt>.</p>
</li>
</ol>
<p>Here is where the second test starts:</p>
<ol class="arabic simple">
<li>Repeat steps 3 - 6.</li>
<li>
<tt class="docutils literal">virsh reboot</tt> the nodes.</li>
<li>Check SSH connection to the rebooted instances.</li>
</ol>
<p>In the future, we would also like to have negative tests on failed take over
for nodes in <tt class="docutils literal">deploying</tt>. We should also have similar tests for cleaning.</p>
</div>
</div>
<div class="section" id="pike-retrospective">
<h2>Pike retrospective</h2>
<p>We've had a short retrospective. Positive items:</p>
<ul class="simple">
<li>Virtual midcycle</li>
<li>Weekly bug liaison (action: start doing it again),</li>
<li>Weekly priorities</li>
<li>Landed some big features</li>
<li>Acknowledge that vendors need more attention</li>
<li>Did not drive our PTL away :)</li>
</ul>
<p>Not so positive:</p>
<ul class="simple">
<li>Loss of people</li>
<li>Gate breakages (action: better hand off of current mitigation actions
between timezones, report on IRC and the whiteboard what you've done and
what's left)</li>
<li>Took too many priorities (action: take less, make the community understand
that priorities != full backlog)</li>
<li>Still not enough attention to vendors (action: accept one patch per vendor
as part of weekly priorities; the same for subteams)</li>
<li>Soft feature freeze</li>
<li>Need more folks reviewing (action: <strong>jlvillal</strong> considers picking up the
weekly review call)</li>
<li>Releasing and cutting stable/pike was a mess (discussed in <a class="reference internal" href="ironic-ptg-denver-2017-1.html#release-cycle">Release cycle</a>)</li>
<li>No alignment between OpenStack releases and vendor hardware releases.</li>
</ul>
</div>
<div class="section" id="release-cycle">
<h2>Release cycle</h2>
<p>We had really hard time releasing Pike. Grenade was branched before us,
essentially messing up our upgrade testing. We had to cut out stable/pike at a
random point, and then backport quite a few features, after repairing the CI.</p>
<p>When discussing that, we noted that we committed to releasing often and early,
but we'd never done it, at least not for ironic itself. Having regular
releases can help us avoiding getting overloaded in the end of the cycle.
We've decided:</p>
<ul class="simple">
<li>Keep master as close to a releasable state as possible, including not
exposing incomplete features to users and keeping release notes polished.</li>
<li>Release regularly, especially when we feel that something is ready to got
out. Let us aim for releasing roughly once a month.</li>
<li>Let us cut stable/pike at the same time as the other projects. We will use
the last released version as a basis for it.</li>
<li>We are going back to feature freeze at the same time as the other projects,
two weeks before the branching at milestone 3. This will allow us to finish
anything requiring finishing, particularly rolling upgrade preparation,
documentation and release notes.</li>
</ul>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../categories/openstack.html" rel="tag">openstack</a></li>
            <li><a class="tag p-category" href="../categories/software.html" rel="tag">software</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="ironic-ptg-atlanta-2017-4.html" rel="prev" title="Atlanta PTG Summary: Ironic (part 4)">Previous post</a>
            </li>
            <li class="next">
                <a href="ironic-ptg-denver-2017-2.html" rel="next" title="Denver PTG Summary: Ironic (part 2)">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="diviusnet2",
            disqus_url="http://dtantsur.github.io/posts/ironic-ptg-denver-2017-1.html",
        disqus_title="Denver PTG Summary: Ironic (part 1)",
        disqus_identifier="cache/posts/ironic-ptg-denver-2017-1.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="diviusnet2";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018 Dmitry Tantsur <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"></a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a>
            
        </footer>
</div>
</div>


            <script src="../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
